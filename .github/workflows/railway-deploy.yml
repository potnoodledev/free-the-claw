name: Prepare Railway deploy branch

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  flatten-submodules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Flatten submodules into regular directories
        run: |
          # Remove submodule tracking
          git rm --cached claude-code-free
          git rm --cached openclaw
          rm -f .gitmodules

          # Remove git history from submodule dirs
          rm -rf claude-code-free/.git
          rm -rf openclaw/.git

          # Re-add as regular directories, including gitignored files (e.g. pnpm-lock.yaml)
          git add --force claude-code-free/
          git add --force openclaw/
          git add .gitmodules

      - name: Push to deploy branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -B deploy
          git commit -m "Flatten submodules for Railway deploy"
          git push --force origin deploy
