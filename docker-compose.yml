services:
  claude-code-free:
    build:
      context: ./claude-code-free
      dockerfile: ../Dockerfile.claude-code-free
    container_name: claude-code-free
    restart: unless-stopped
    ports:
      - "8082:8082"
    environment:
      # NVIDIA NIM API Key (required) - get from https://build.nvidia.com/settings/api-keys
      - NVIDIA_NIM_API_KEY=${NVIDIA_NIM_API_KEY}
      # Model selection
      - MODEL=${MODEL:-stepfun-ai/step-3.5-flash}
      # NVIDIA NIM settings
      - NVIDIA_NIM_MAX_TOKENS=81920
      - NVIDIA_NIM_TEMPERATURE=1.0
      - NVIDIA_NIM_TOP_P=1.0
      - NVIDIA_NIM_TOP_K=-1
      - NVIDIA_NIM_RATE_LIMIT=40
      - NVIDIA_NIM_RATE_WINDOW=60
      - NVIDIA_NIM_REASONING_EFFORT=high
      - NVIDIA_NIM_INCLUDE_REASONING=true
      - NVIDIA_NIM_PRESENCE_PENALTY=0.0
      - NVIDIA_NIM_FREQUENCY_PENALTY=0.0
      - NVIDIA_NIM_MIN_P=0.0
      - NVIDIA_NIM_REPETITION_PENALTY=1.0
      - NVIDIA_NIM_PARALLEL_TOOL_CALLS=true
      # Agent config
      - CLAUDE_WORKSPACE=./agent_workspace
      - MAX_CLI_SESSIONS=10
      - ALLOWED_DIR=
      - FAST_PREFIX_DETECTION=true
      - ENABLE_NETWORK_PROBE_MOCK=true
      - ENABLE_TITLE_GENERATION_SKIP=true
      - ENABLE_SUGGESTION_MODE_SKIP=true
      - ENABLE_FILEPATH_EXTRACTION_MOCK=true
      # Telegram (optional)
      - TELEGRAM_BOT_TOKEN=
      - ALLOWED_TELEGRAM_USER_ID=
      - MESSAGING_RATE_LIMIT=1
      - MESSAGING_RATE_WINDOW=1
    volumes:
      - claude-code-free-workspace:/app/agent_workspace

  openclaw:
    build: ./openclaw
    container_name: openclaw
    restart: unless-stopped
    depends_on:
      - claude-code-free
    ports:
      - "18789:18789"
      - "18790:18790"
    environment:
      - HOME=/home/node
      - TERM=xterm-256color
      # Model name (auto-synced from .env for accurate display)
      - MODEL=${MODEL:-stepfun-ai/step-3.5-flash}
      # API key passed to openclaw config (can be any non-empty value for the proxy)
      - ANTHROPIC_API_KEY=sk-placeholder
      # Gateway access token - change this to secure your gateway
      - OPENCLAW_GATEWAY_TOKEN=changeme
      # Optional: password auth instead of token
      - OPENCLAW_GATEWAY_PASSWORD=
      # GitHub PAT: enables agent persona (SOUL.md) + git operations
      - GITHUB_PAT_TOKEN=${GITHUB_PAT_TOKEN}
      # Twitter/X: enables tweeting + reading mentions as @voxxelle_
      - TWITTER_CLIENT_ID=${TWITTER_CLIENT_ID}
      - TWITTER_CLIENT_SECRET=${TWITTER_CLIENT_SECRET}
      - TWITTER_BEARER_TOKEN=${TWITTER_BEARER_TOKEN}
      - TWITTER_REFRESH_TOKEN=${TWITTER_REFRESH_TOKEN}
    user: "root"
    volumes:
      - ./openclaw-config:/openclaw-config:ro
      - openclaw-data:/home/node/.openclaw
    init: true
    entrypoint: ["/bin/sh", "/openclaw-config/entrypoint.sh"]
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--allow-unconfigured",
        "--bind",
        "lan",
        "--port",
        "18789",
      ]

  radicle-seed:
    build:
      context: .
      dockerfile: Dockerfile.radicle-seed
    container_name: radicle-seed
    restart: unless-stopped
    ports:
      - "8776:8776"   # P2P gossip protocol
      - "8080:8080"   # HTTP API
    volumes:
      - ./radicle-config:/radicle-config:ro
      - radicle-data:/home/radicle/.radicle
    environment:
      - RAD_ALIAS=${RAD_ALIAS:-seed}
      - RAD_PASSPHRASE=${RAD_PASSPHRASE:-}
      - RAD_SEED_POLICY=${RAD_SEED_POLICY:-allow}
      - RAD_SEED_SCOPE=${RAD_SEED_SCOPE:-all}
      - RAD_EXTERNAL_ADDRESS=${RAD_EXTERNAL_ADDRESS:-}

  radicle-explorer:
    build:
      context: .
      dockerfile: Dockerfile.radicle-explorer
    container_name: radicle-explorer
    restart: unless-stopped
    depends_on:
      - radicle-seed
    ports:
      - "8081:80"
    environment:
      - EXPLORER_PREFERRED_SEED=${EXPLORER_PREFERRED_SEED:-radicle-seed}
      - EXPLORER_PREFERRED_SEED_PORT=${EXPLORER_PREFERRED_SEED_PORT:-8080}
      - EXPLORER_PREFERRED_SEED_SCHEME=${EXPLORER_PREFERRED_SEED_SCHEME:-http}
      - EXPLORER_HTTPD_PORT=${EXPLORER_HTTPD_PORT:-8080}
      - EXPLORER_LOCAL_HTTPD_PORT=${EXPLORER_LOCAL_HTTPD_PORT:-8080}
      - EXPLORER_HTTPD_SCHEME=${EXPLORER_HTTPD_SCHEME:-http}

volumes:
  claude-code-free-workspace:
  openclaw-data:
  radicle-data:
